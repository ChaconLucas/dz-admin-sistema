<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat D&Z - Dashboard de Monitoramento</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-danger: #ff1493;
        --color-success: #28a745;
        --color-warning: #ffc107;
        --color-white: #fff;
        --color-light: #f4f6f8;
        --color-background: #f6f6f9;
        --color-dark: #363949;
        --color-dark-variant: #677483;
        --color-baby-pink: #ff69b4;
        --box-shadow: 0 2rem 3rem rgba(132, 139, 200, 0.18);
        --card-border-radius: 2rem;
        --border-radius-1: 0.4rem;
        --border-radius-2: 0.8rem;
        --border-radius-3: 1.2rem;
        --card-padding: 1.8rem;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: var(--color-background);
        min-height: 100vh;
        padding: 20px;
        color: var(--color-dark);
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        height: calc(100vh - 40px);
      }

      /* Chat Container - Lado Esquerdo */
      .chat-container {
        background: var(--color-white);
        border-radius: var(--card-border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
        padding: var(--card-padding);
        text-align: center;
      }

      .chat-header h2 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .chat-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
      }

      .chat-messages {
        flex: 1;
        padding: var(--card-padding);
        overflow-y: auto;
        background: var(--color-light);
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .message.bot .message-bubble {
        background: var(--color-white);
        border: 1px solid #e9ecef;
        color: var(--color-dark);
      }

      .message.user .message-bubble {
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin: 5px 0 0 0;
      }

      .chat-input-container {
        padding: var(--card-padding);
        background: var(--color-white);
        border-top: 1px solid #e9ecef;
      }

      .welcome-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .welcome-form input {
        padding: 12px 16px;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius-2);
        font-size: 14px;
        transition: border-color 0.3s;
        background: var(--color-light);
      }

      .welcome-form input:focus {
        outline: none;
        border-color: var(--color-danger);
        background: var(--color-white);
      }

      .welcome-form button {
        padding: 12px 16px;
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
        border: none;
        border-radius: var(--border-radius-2);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .welcome-form button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 20, 147, 0.3);
      }

      .chat-input {
        display: none;
        align-items: center;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e9ecef;
        border-radius: 25px;
        font-size: 14px;
        background: var(--color-light);
      }

      .chat-input input:focus {
        outline: none;
        border-color: var(--color-danger);
        background: var(--color-white);
      }

      .chat-input button {
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .chat-input button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 20, 147, 0.3);
      }

      /* Monitoring Panel - Lado Direito */
      .monitoring-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .panel-section {
        background: var(--color-white);
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
      }

      .panel-section:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(255, 20, 147, 0.15);
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin-bottom: 1rem;
      }

      .section-header .icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
      }

      .section-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-dark);
      }

      /* Monitor de Performance */
      .performance-metrics {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem;
        background: var(--color-light);
        border-radius: var(--border-radius-2);
        border-left: 4px solid var(--color-danger);
      }

      .metric-label {
        font-size: 0.85rem;
        color: var(--color-dark-variant);
        font-weight: 500;
      }

      .metric-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-danger);
      }

      /* Alertas Cr√≠ticos */
      .alerts-feed {
        max-height: 200px;
        overflow-y: auto;
      }

      .alert-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: var(--color-light);
        border-radius: var(--border-radius-1);
        border-left: 3px solid var(--color-warning);
        transition: all 0.3s ease;
      }

      .alert-item:hover {
        background: #fff8e1;
        transform: translateX(4px);
      }

      .alert-item.critical {
        border-left-color: var(--color-danger);
      }

      .alert-item.critical:hover {
        background: #ffeef3;
      }

      .alert-icon {
        font-size: 1.2rem;
        color: var(--color-warning);
      }

      .alert-item.critical .alert-icon {
        color: var(--color-danger);
      }

      .alert-content {
        flex: 1;
      }

      .alert-title {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        color: var(--color-dark);
      }

      .alert-time {
        font-size: 0.7rem;
        color: var(--color-dark-variant);
      }

      /* A√ß√µes R√°pidas */
      .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .action-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        padding: 0.8rem;
        border: none;
        border-radius: var(--border-radius-2);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
      }

      .action-button.primary {
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
      }

      .action-button.secondary {
        background: var(--color-light);
        color: var(--color-dark);
        border: 1px solid #ddd;
      }

      .action-button:hover {
        transform: translateY(-2px);
      }

      .action-button.primary:hover {
        box-shadow: 0 4px 12px rgba(255, 20, 147, 0.3);
      }

      .action-button.secondary:hover {
        background: var(--color-white);
        border-color: var(--color-danger);
        color: var(--color-danger);
      }

      /* Lista de Administradores */
      .admin-list {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .admin-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.6rem;
        background: var(--color-light);
        border-radius: var(--border-radius-1);
        transition: all 0.3s ease;
      }

      .admin-item:hover {
        background: var(--color-white);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .admin-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--color-danger),
          var(--color-baby-pink)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
      }

      .admin-info {
        flex: 1;
      }

      .admin-name {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.1rem;
        color: var(--color-dark);
      }

      .admin-status {
        font-size: 0.7rem;
        color: var(--color-success);
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--color-success);
      }

      .typing-indicator {
        display: none;
        padding: 12px 16px;
        background: var(--color-white);
        border-radius: 18px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dots span {
        width: 8px;
        height: 8px;
        background: var(--color-danger);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }

      .powered-by {
        text-align: center;
        padding: 10px;
        font-size: 12px;
        color: var(--color-dark-variant);
        background: var(--color-light);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      /* Responsividade */
      @media screen and (max-width: 1024px) {
        .dashboard-container {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .monitoring-panel {
          order: -1;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Chat Container - Lado Esquerdo -->
      <div class="chat-container">
        <div class="chat-header">
          <h2>
            <span class="material-symbols-sharp">chat</span>
            Chat D&Z
          </h2>
          <p>Atendimento inteligente online</p>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message bot">
            <div class="message-bubble">
              Ol√°! üëã Bem-vindo ao D&Z! <br />
              Sou sua assistente virtual e estou aqui para ajudar. Para come√ßar,
              me conte seu nome e como posso ajud√°-lo hoje?
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <form class="welcome-form" id="welcomeForm">
            <input type="text" id="nome" placeholder="Seu nome" required />
            <input type="email" id="email" placeholder="Seu e-mail" required />
            <input
              type="text"
              id="mensagem"
              placeholder="Como posso ajudar voc√™?"
              required
            />
            <button type="submit">
              <span class="material-symbols-sharp">send</span>
              Iniciar conversa
            </button>
          </form>

          <div class="chat-input" id="chatInput">
            <input
              type="text"
              id="messageInput"
              placeholder="Digite sua mensagem..."
            />
            <button onclick="enviarMensagem()">
              <span class="material-symbols-sharp">send</span>
            </button>
          </div>
        </div>

        <div class="powered-by">
          <span class="material-symbols-sharp">smart_toy</span>
          Powered by IA D&Z
        </div>
      </div>

      <!-- Monitoring Panel - Lado Direito -->
      <div class="monitoring-panel">
        <!-- Monitor de Performance da IA -->
        <div class="panel-section">
          <div class="section-header">
            <div class="icon">
              <span class="material-symbols-sharp">speed</span>
            </div>
            <h3>Performance da IA</h3>
          </div>
          <div class="performance-metrics">
            <div class="metric-item">
              <span class="metric-label">Taxa de Sucesso</span>
              <span class="metric-value" id="successRate">85%</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Tempo de Resposta</span>
              <span class="metric-value" id="responseTime">1.2s</span>
            </div>
          </div>
        </div>

        <!-- Alertas Cr√≠ticos -->
        <div class="panel-section">
          <div class="section-header">
            <div class="icon">
              <span class="material-symbols-sharp">warning</span>
            </div>
            <h3>Alertas Cr√≠ticos</h3>
          </div>
          <div class="alerts-feed" id="alertsFeed">
            <div class="alert-item critical">
              <span class="material-symbols-sharp alert-icon">emergency</span>
              <div class="alert-content">
                <div class="alert-title">Sentimento negativo detectado</div>
                <div class="alert-time">h√° 2 min</div>
              </div>
            </div>
            <div class="alert-item">
              <span class="material-symbols-sharp alert-icon">schedule</span>
              <div class="alert-content">
                <div class="alert-title">Aguardando interven√ß√£o humana</div>
                <div class="alert-time">h√° 3 min</div>
              </div>
            </div>
            <div class="alert-item critical">
              <span class="material-symbols-sharp alert-icon"
                >priority_high</span
              >
              <div class="alert-content">
                <div class="alert-title">Cliente insatisfeito - Chat #1234</div>
                <div class="alert-time">h√° 5 min</div>
              </div>
            </div>
          </div>
        </div>

        <!-- A√ß√µes R√°pidas -->
        <div class="panel-section">
          <div class="section-header">
            <div class="icon">
              <span class="material-symbols-sharp">bolt</span>
            </div>
            <h3>A√ß√µes R√°pidas</h3>
          </div>
          <div class="quick-actions">
            <button class="action-button primary" id="pauseAI">
              <span class="material-symbols-sharp">pause_circle</span>
              Pausar IA Geral
            </button>
            <button class="action-button secondary" id="exportReports">
              <span class="material-symbols-sharp">download</span>
              Exportar Relat√≥rios do Dia
            </button>
          </div>
        </div>

        <!-- Lista de Administradores -->
        <div class="panel-section">
          <div class="section-header">
            <div class="icon">
              <span class="material-symbols-sharp">admin_panel_settings</span>
            </div>
            <h3>Admins Online</h3>
          </div>
          <div class="admin-list">
            <div class="admin-item">
              <div class="admin-avatar">AH</div>
              <div class="admin-info">
                <div class="admin-name">Ana Helena</div>
                <div class="admin-status">
                  <div class="status-dot"></div>
                  Online
                </div>
              </div>
            </div>
            <div class="admin-item">
              <div class="admin-avatar">CS</div>
              <div class="admin-info">
                <div class="admin-name">Carlos Silva</div>
                <div class="admin-status">
                  <div class="status-dot"></div>
                  Online
                </div>
              </div>
            </div>
            <div class="admin-item">
              <div class="admin-avatar">MF</div>
              <div class="admin-info">
                <div class="admin-name">Maria Fernanda</div>
                <div class="admin-status">
                  <div class="status-dot"></div>
                  Online
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let conversaId = null;
      let nomeUsuario = "";
      let aiPaused = false;

      // Inicializar conversa
      document
        .getElementById("welcomeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nome = document.getElementById("nome").value;
          const email = document.getElementById("email").value;
          const mensagem = document.getElementById("mensagem").value;

          if (!nome || !email || !mensagem) return;

          try {
            console.log("Enviando para:", "../php/chat-api.php");
            console.log("Dados:", { nome, email, mensagem });

            const response = await fetch("../php/chat-api.php", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "start_conversation",
                nome: nome,
                email: email,
                mensagem: mensagem,
              }),
            });

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`,
              );
            }

            const responseText = await response.text();
            console.log("Response raw:", responseText);

            const data = JSON.parse(responseText);
            console.log("Resposta:", data);

            if (data.success) {
              conversaId = data.conversa_id;
              nomeUsuario = nome;

              // Esconder formul√°rio inicial
              document.getElementById("welcomeForm").style.display = "none";
              document.getElementById("chatInput").style.display = "flex";

              // Adicionar primeira mensagem do usu√°rio
              adicionarMensagem(mensagem, "user");

              // Simular resposta da IA
              mostrarTyping();

              setTimeout(() => {
                esconderTyping();
                adicionarMensagem(
                  data.resposta ||
                    `Ol√° ${nome}! Recebi sua mensagem e vou te ajudar com isso. Em que mais posso auxiliar?`,
                  "bot",
                );

                // Atualizar m√©tricas
                atualizarMetricas();
              }, 2000);
            } else {
              alert("Erro ao iniciar conversa: " + data.error);
            }
          } catch (error) {
            console.error("Erro detalhado:", error);
            alert("Erro de conex√£o: " + error.message);
          }
        });

      // Enviar mensagem
      async function enviarMensagem() {
        const input = document.getElementById("messageInput");
        const mensagem = input.value.trim();

        if (!mensagem || aiPaused) {
          if (aiPaused) {
            alert("IA pausada. Ative novamente para continuar.");
          }
          return;
        }

        input.value = "";
        adicionarMensagem(mensagem, "user");

        mostrarTyping();

        try {
          const response = await fetch("../php/chat-api.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              action: "send_message",
              conversa_id: conversaId,
              mensagem: mensagem,
            }),
          });

          const data = await response.json();

          esconderTyping();

          if (data.success) {
            adicionarMensagem(data.resposta, "bot");
            atualizarMetricas();

            // Simular detec√ß√£o de sentimento negativo (exemplo)
            if (
              mensagem.toLowerCase().includes("ruim") ||
              mensagem.toLowerCase().includes("problema")
            ) {
              adicionarAlerta("Sentimento negativo detectado", "critical");
            }
          } else {
            adicionarMensagem(
              "Desculpe, houve um erro. Tente novamente.",
              "bot",
            );
          }
        } catch (error) {
          esconderTyping();
          adicionarMensagem("Erro de conex√£o. Verifique sua internet.", "bot");
        }
      }

      // Enter para enviar
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            enviarMensagem();
          }
        });

      function adicionarMensagem(texto, tipo) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${tipo}`;

        messageDiv.innerHTML = `
          <div class="message-bubble">
            ${texto}
            <div class="message-time">${new Date().toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })}</div>
          </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function mostrarTyping() {
        const chatMessages = document.getElementById("chatMessages");
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.id = "typing";
        typingDiv.innerHTML = `
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function esconderTyping() {
        const typing = document.getElementById("typing");
        if (typing) {
          typing.remove();
        }
      }

      // Fun√ß√µes do Painel de Monitoramento
      function atualizarMetricas() {
        // Simular atualiza√ß√£o de m√©tricas
        const successRate = Math.floor(Math.random() * 10) + 80; // 80-90%
        const responseTime = (Math.random() * 1 + 0.8).toFixed(1); // 0.8-1.8s

        document.getElementById("successRate").textContent = `${successRate}%`;
        document.getElementById("responseTime").textContent =
          `${responseTime}s`;
      }

      function adicionarAlerta(mensagem, tipo = "warning") {
        const alertsFeed = document.getElementById("alertsFeed");
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert-item ${tipo}`;

        const icon = tipo === "critical" ? "priority_high" : "schedule";

        alertDiv.innerHTML = `
          <span class="material-symbols-sharp alert-icon">${icon}</span>
          <div class="alert-content">
            <div class="alert-title">${mensagem}</div>
            <div class="alert-time">agora</div>
          </div>
        `;

        alertsFeed.insertBefore(alertDiv, alertsFeed.firstChild);

        // Limitar a 5 alertas
        if (alertsFeed.children.length > 5) {
          alertsFeed.removeChild(alertsFeed.lastChild);
        }
      }

      // Pausar/Reativar IA
      document.getElementById("pauseAI").addEventListener("click", function () {
        aiPaused = !aiPaused;
        this.innerHTML = aiPaused
          ? '<span class="material-symbols-sharp">play_circle</span> Reativar IA Geral'
          : '<span class="material-symbols-sharp">pause_circle</span> Pausar IA Geral';

        this.className = aiPaused
          ? "action-button secondary"
          : "action-button primary";

        const status = aiPaused
          ? "IA pausada pelo administrador"
          : "IA reativada";
        adicionarAlerta(status, aiPaused ? "critical" : "warning");
      });

      // Exportar Relat√≥rios
      document
        .getElementById("exportReports")
        .addEventListener("click", function () {
          adicionarAlerta("Relat√≥rio do dia sendo gerado", "warning");

          setTimeout(() => {
            // Simular download
            const link = document.createElement("a");
            link.href =
              "data:text/plain;charset=utf-8," +
              encodeURIComponent(
                `Relat√≥rio D&Z - ${new Date().toLocaleDateString("pt-BR")}\n\n` +
                  `Total de conversas: ${Math.floor(Math.random() * 50) + 20}\n` +
                  `Taxa de sucesso: ${document.getElementById("successRate").textContent}\n` +
                  `Tempo m√©dio de resposta: ${document.getElementById("responseTime").textContent}\n`,
              );
            link.download = `relatorio_${new Date().toISOString().split("T")[0]}.txt`;
            link.click();

            adicionarAlerta("Relat√≥rio baixado com sucesso", "warning");
          }, 2000);
        });

      // Atualizar m√©tricas periodicamente
      setInterval(atualizarMetricas, 10000); // A cada 10 segundos

      // Simular alertas peri√≥dicos
      setInterval(() => {
        const alertas = [
          "Nova conversa iniciada",
          "Cliente solicitou atendimento humano",
          "Tempo de resposta alto detectado",
          "Feedback positivo recebido",
        ];

        const alertaRandom =
          alertas[Math.floor(Math.random() * alertas.length)];
        adicionarAlerta(alertaRandom);
      }, 30000); // A cada 30 segundos
    </script>
  </body>
</html>
